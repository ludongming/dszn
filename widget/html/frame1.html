<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link rel="stylesheet" href="../css/weui.min.css" />
	<link rel="stylesheet" type="text/css" href="../css/api.css" />
	<link rel="stylesheet" href="../css/header.css" />
	<link rel="stylesheet" href="../css/swiper.min.css" />
	<style>
		body {
			background: #f5f5f5!important;
			width: 100%;

		}

		#password {
			height: 60px;
		}

		.weui-cells__title {
			margin-bottom: 25px;
		}



		.swiper-slide {
			width: 100%;
			height: 120px;
			text-align: center;
				border-bottom: 1px solid #ccc;

		}
		.swiper-slide img{
			max-width: 100%;
			max-height: 120px;
		}



		.help {
			color: #666;
			width: 100%;
			clear: both;
			height: 30px;
			text-align: center;
			display: block;
			position: absolute;
			bottom: 20px;
		}

		.adv {
			width: 100%;

			margin-top: 34px;
		}

		.adv img {
			height: 130px;
			margin: auto;
		}
		.advimg{
				width: 100% !important;
				height: 130px!important;
				}
		.dswrap{
			width: 100%;

			margin-top:10px;
			background-color: #fff;
		}
		.mobile{
			color: #e9a43d;
		}
		.d_shang{
			color: #89be25;
		}
		.dswrap .dstitle{
			width: 30%;
			height: 100px;
			float: left;

			margin: 5px;

		border:1px solid #ccc;




		}
		.dswrap .dstitle img{
			width: 30px;
			float: right;

		}
		 .ydtitle{
			width: 46% !important;

		}
		.dswrap .dswraptitle{

				height: 30px;
				text-align: center;
				line-height: 30px;
				font-size: 1.2em;


		}
		.dswrap .dswraptitle img{
				width: 20px;
				margin-right: 5px;
				vertical-align:middle;

		}
		.remark{
			width: 50px;
			height: 20px;
			border-radius: 10px;
		color:#fff;
			text-align: center;
			line-height: 20px;
			margin: 15px auto;


		}
		.character{
			margin: auto;
			text-align: center;
			margin: 3px;

			vertical-align: middle;
			margin-top: -5px;

		}
		.clear{
			clear: both;
		}
	</style>
</head>

<body>
	<header style="position: fixed;">
		<span style="text-align: center;">订购</span>
	</header>
	<div class="page__bd content">
		<div class="adv">
			<div class="advimg" data-nodeid="1"  data-url="./buy/rank.html" >
					<div class="swiper-slide">
						<img src="../image/ds/rank.png" class="pic" data-original=""></div>
			</div>
		</div>

		<div class="dswrap">
			<div class="dswraptitle d_shang"><img src="../icon/icon150x150.png" alt="">顶上</div>
			<div class="dstitle ydtitle" data-nodeid="1" data-url="./buy/index.html"><div class="remark" style="background-color:#e84c3d">上市</div><div class="character">集成吊顶产品库 /VIP产品</div></div>
			<div class="dstitle ydtitle" data-nodeid="2" data-url="./qm/index.html"><div class="remark" style="background-color:#8d44ad">高新</div><div class="character">集成背景·墙面</div></div>
			<div class="dstitle ydtitle" data-nodeid="1" data-url="./factory/index.html"><div class="remark" style="background-color:#27ae61">环保</div><div class="character">工程定制</div></div>
			<div class="dstitle ydtitle" data-nodeid="1" data-url="#"><div class="remark" style="background-color:#aa6237">专利</div><div class="character">干衣装备/晾衣架</div></div>
			<div class="clear"></div>
		</div>
		<div class="dswrap">
			<div class="dswraptitle mobile">MOBILE 移动</div>
			<div class="dstitle ydtitle" data-nodeid="4" data-url="./ydqm/index.html"><div class="remark" style="background-color:#f39c11">10大</div><div class="character">集成背景·墙面</div></div>
			<div class="dstitle ydtitle" data-nodeid="3" data-url="./ydceil/index.html"><div class="remark" style="background-color:#3598dc">定制</div><div class="character">集成吊顶</div></div>
			<div class="clear"></div>
		</div>
		<div style="height:50px;"></div>
	</div>

</body>

<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/weui.min.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/wolf.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/zepto.picLazyLoad.min.js"></script>
<script src="../script/swiper-3.3.1.min.js"></scrip>
<script type="text/javascript">
	var OPENID;
	var NODE;
	var URL;
	apiready = function() {
		OPENID = api.getPrefs({
			sync: true,
			key: 'openid'
		});

		setTopBar();
		$(".dstitle").bind("click", shows);
	$(".advimg").bind("click", shows);
	$('.pic').picLazyLoad();
	};

	function shows() {
		NODE = $(this).attr("data-nodeid");
		URL = $(this).attr("data-url");
		//免密码
		var ret = getLocalPassword();


		if (ret.status == true) {
			checkQX(ret.password, 0);
			return false;
		}



		var isFinger = api.getPrefs({
			sync: true,
			key: 'fingerPrint'
		});

		var OS = api.systemType;
		if (OS == "ios" && isFinger == 1) {
			var touchID = api.require('touchID');

			touchID.verify(
				function(ret, err) {
					if (ret.status) {
						fingerPrint();
					} else {
						if (ret.code == 0) {
							setPassword();
						} else if (ret.code == 1) {
							setPassword();

						} else if (ret.code == 2) {
							api.alert({
								msg: "验证三次失败,请用密码输入"
							});
							setPassword();

						} else if (ret.code == 3) {
							setPassword();

						} else {

							setPassword();
						}
					}
				});
		} else {
			setPassword();
		}
	}



	function setPassword() {


		api.prompt({
			title: '授权密码',
			msg: '授权后1小时内免密码输入哦',
			buttons: ['取消', '确定']
		}, function(ret, err) {
			var index = ret.buttonIndex;
			var text = ret.text;
			if (index == 2) {
				sq(ret.text);
			}
		});

	}



	function help() {
		api.openWin({
			name: 'letter',
			url: './active/letter.html',
			slidBackEnabled: false
		});
	}


	function sq(password) {


		if (password == null || password == undefined) {
			api.toast({
				msg: '授权密码不能为空',
				duration: 1000,
				location: 'middle'
			});
			return false;
		}
		checkQX(password, 1);
	}


	function fingerPrint() {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/fingerprint/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}


	function checkQX(password, isAutoPwd) {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/authorize/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"password": password,
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				//授权成功记住密码
				recordPassword(password, isAutoPwd);


				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}

	function jump() {

		var num = Math.round(Math.random() * 10);
		if (NODE == 1) {
			api.openWin({
				name: 'buy' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
		if (NODE == 2) {
			api.openWin({
				name: 'qm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}

		if (NODE == 3) {
			api.openWin({
				name: 'ydceil' + num,
				url: URL,
				slidBackEnabled: false
			});
		}


		if (NODE == 4) {
			api.openWin({
				name: 'ydqm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
	}

	function recordPassword(password, isAutoPwd) {

		if (isAutoPwd == 0) {
			return false;
		}

		var add_time = new Date().getTime();
		var obj = {
			"password": password,
			"add_time": add_time
		};

		var objString = JSON.stringify(obj);
		api.setPrefs({
			key: 'password',
			value: obj
		});
	}

	function getLocalPassword() {
		var string = api.getPrefs({
			key: 'password',
			sync: true
		});
    if(string==""){
			return {"status":false,"password":""};
		}

		var obj = $.parseJSON(string);
		var currentTime = new Date().getTime();
		var ret;
		if ((currentTime - obj.add_time) > 3600000) {
			ret = {
				"status": false,
				'password': ""
			};
		} else {
			ret = {
				"status": true,
				"password": obj.password
			};
		}
		return ret;

	}
</script>

</html>
