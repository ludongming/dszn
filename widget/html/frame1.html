<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link rel="stylesheet" href="../css/weui.min.css" />
	<link rel="stylesheet" type="text/css" href="../css/api.css" />
	<link rel="stylesheet" href="../css/header.css" />
	<link rel="stylesheet" href="../css/swiper.min.css" />
	<style>
		body {
			background: #f8f8f8!important;
			width: 100%;
		}

		#password {
			height: 60px;
		}

		.weui-cells__title {
			margin-bottom: 25px;
		}


		.help {
			color: #666;
			width: 100%;
			clear: both;
			height: 30px;
			text-align: center;
			display: block;
			position: absolute;
			bottom: 20px;
		}

		.adv {
			width: 100%;
		}

		.adv img {
			width:100%;
			margin: auto;
		}



		.dswrap {
			width: 100%;
			margin-top: 10px;
			background-color: #fff;
		}

		.mobile {
			color: #777;
		}

		.d_shang {
			color: #89be25;
		}

		.dswrap .dstitle {
			width: 49%;
			height: 100px;
			position: relative;
			float: left;
			margin-left: 10px;
			margin-bottom: 10px;
			border-radius: 4px;
		}

		.dswrap .dstitle img {
			width: 30px;
			float: right;
		}

		.ydtitle {
			width: 46% !important;
		}

		.dswrap .dswraptitle {
			height: 30px;
			text-align: center;
			font-size: 1.2em;
		}

		.dswrap .dswraptitle img {
			width: 20px;
			margin-right: 5px;
			vertical-align: middle;
		}

		.remark {
			width: 100%;
			height: 30px;
			color: #fff;
			font-size:1em;
			text-align: center;
			line-height: 30px;
			margin: 20px auto;
		}

		.character {
			position: absolute;
		  bottom:0px;
			width:100%;
			background: #fff;
			opacity: 0.5;
			height:33px;
			font-size:0.9em;
			text-align: center;
			line-height: 33px;
		}

		.clear {
			clear: both;
		}
	</style>
</head>

<body>
	<header style="position: fixed;">
		<span style="text-align: center;">订购</span>
	</header>
	<div class="page__bd content">
		<div class="adv">
			<div class="advimg" data-nodeid="1" data-url="./buy/rank.html">
					<img src="../image/ds/dinggouadv.jpg" id="adv"></div>
		</div>

		<div class="dswrap">
			<div class="dswraptitle mobile">DS顶上</div>
			<div class="dstitle ydtitle" style="background:#76c6a9;" data-nodeid="1" data-url="./buy/index.html">
				<div class="character">上市企业</div>
				<div class="remark">集成吊顶产品库 /VIP产品</div>
			</div>
			<div class="dstitle ydtitle" style="background:#01a9ea;" data-nodeid="2" data-url="./qm/index.html">
				<div class="character">高新技术</div>
				<div class="remark">集成背景·墙面</div>
			</div>
			<div class="dstitle ydtitle" style="background:#f4b317;" data-nodeid="1" data-url="./factory/index.html">
				<div class="character">环保认证</div>
				<div class="remark">工程定制</div>
			</div>
			<div class="dstitle ydtitle" style="background:#72910f;" data-nodeid="5" data-url="./clothes/index.html">
				<div class="character">400项国家专利</div>
				<div class="remark">干衣装备/晾衣架</div>

			</div>
			<div class="clear"></div>
		</div>
		<div class="dswrap">
			<div class="dswraptitle mobile">MOBILE 移动</div>
			<div class="dstitle ydtitle" style="background:#2e8f64;" data-nodeid="4" data-url="./ydqm/index.html">
				<div class="character">10大品牌</div>
				<div class="remark">集成背景·墙面</div>

			</div>
			<div class="dstitle ydtitle" style="background:#f256a0;" data-nodeid="3" data-url="./ydceil/index.html">
				<div class="character">百变定制</div>
				<div class="remark">集成吊顶</div>

			</div>
			<div class="clear"></div>
		</div>
		<div style="height:50px;"></div>
	</div>

</body>

<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/weui.min.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/wolf.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/zepto.picLazyLoad.min.js"></script>
<script src="../script/swiper-3.3.1.min.js"></script>
<script type="text/javascript">
	var OPENID;
	var NODE;
	var URL;
	apiready = function() {
		OPENID = api.getPrefs({
			sync: true,
			key: 'openid'
		});
loadAdv();
		setTopBar();
		$(".dstitle").bind("click", shows);
		$(".advimg").bind("click", shows);
	};

	function shows() {
		NODE = $(this).attr("data-nodeid");
		URL = $(this).attr("data-url");
		//免密码
		var ret = getLocalPassword();


		if (ret.status == true) {
			checkQX(ret.password, 0);
			return false;
		}



		var isFinger = api.getPrefs({
			sync: true,
			key: 'fingerPrint'
		});

		var OS = api.systemType;
		if (OS == "ios" && isFinger == 1) {
			var touchID = api.require('touchID');

			touchID.verify(
				function(ret, err) {
					if (ret.status) {
						fingerPrint();
					} else {
						if (ret.code == 0) {
							setPassword();
						} else if (ret.code == 1) {
							setPassword();

						} else if (ret.code == 2) {
							api.alert({
								msg: "验证三次失败,请用密码输入"
							});
							setPassword();

						} else if (ret.code == 3) {
							setPassword();

						} else {

							setPassword();
						}
					}
				});
		} else {
			setPassword();
		}
	}

	function loadAdv() {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?app/getadv/?id=120&openid=' + OPENID
		}, function(ret, err) {
			//coding...
			$("#adv").attr("src", "http://www.d-shang.com/" + ret.data.image);
		});
	}


	function setPassword() {


		api.prompt({
			title: '授权密码',
			msg: '授权后1小时内免密码输入哦',
			buttons: ['取消', '确定']
		}, function(ret, err) {
			var index = ret.buttonIndex;
			var text = ret.text;
			if (index == 2) {
				sq(ret.text);
			}
		});

	}



	function help() {
		api.openWin({
			name: 'letter',
			url: './active/letter.html',
			slidBackEnabled: false
		});
	}


	function sq(password) {


		if (password == null || password == undefined) {
			api.toast({
				msg: '授权密码不能为空',
				duration: 1000,
				location: 'middle'
			});
			return false;
		}
		checkQX(password, 1);
	}


	function fingerPrint() {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/fingerprint/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}


	function checkQX(password, isAutoPwd) {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/authorize/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"password": password,
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				//授权成功记住密码
				recordPassword(password, isAutoPwd);


				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}

	function jump() {

		var num = Math.round(Math.random() * 10);
		if (NODE == 1) {
			api.openWin({
				name: 'buy' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
		if (NODE == 2) {
			api.openWin({
				name: 'qm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}

		if (NODE == 3) {
			api.openWin({
				name: 'ydceil' + num,
				url: URL,
				slidBackEnabled: false
			});
		}


		if (NODE == 4) {
			api.openWin({
				name: 'ydqm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}

		if (NODE == 5) {
			api.openWin({
				name: 'clothes' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
	}

	function recordPassword(password, isAutoPwd) {

		if (isAutoPwd == 0) {
			return false;
		}

		var add_time = new Date().getTime();
		var obj = {
			"password": password,
			"add_time": add_time
		};

		var objString = JSON.stringify(obj);
		api.setPrefs({
			key: 'password',
			value: obj
		});
	}

	function getLocalPassword() {
		var string = api.getPrefs({
			key: 'password',
			sync: true
		});
		if (string == "") {
			return {
				"status": false,
				"password": ""
			};
		}

		var obj = $.parseJSON(string);
		var currentTime = new Date().getTime();
		var ret;
		if ((currentTime - obj.add_time) > 3600000) {
			ret = {
				"status": false,
				'password': ""
			};
		} else {
			ret = {
				"status": true,
				"password": obj.password
			};
		}
		return ret;

	}
</script>

</html>
