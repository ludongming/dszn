<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link rel="stylesheet" href="../css/weui.min.css" />
	<link rel="stylesheet" type="text/css" href="../css/api.css" />
	<link rel="stylesheet" href="../css/header.css" />
	<link rel="stylesheet" href="../css/swiper.min.css" />
	<style>
		body {
			background: #f5f5f5!important;
			width: 100%;
			height: 730px;
		}

		#password {
			height: 60px;
		}

		.weui-cells__title {
			margin-bottom: 25px;
		}

		.box {
			background: #fff;
			margin-top: 10px;
			width: 100%;
			height: 60px;
			text-align: left;
			float: left;
			font-size: 1.2em;
			line-height: 60px;
			border-top: 1px #eee solid;
			border-bottom: 1px #eee solid;
		}

		.swiper-slide {
			width: 100%;
			height: 300px;
		}

		.box .img {
			margin-top: 15px;
			margin-left: 10px;
			margin-right: 10px;
			border-radius: 15px;
			width: 60px;
			height: 30px;
			text-align: center;
			line-height: 30px;
			color: #fff;
			font-size: 0.8em;
			background: #e67f22;
			float: left;
		}

		.box span {
			display: block;
		}

		.help {
			color: #666;
			width: 100%;
			clear: both;
			height: 30px;
			text-align: center;
			display: block;
			position: absolute;
			bottom: 20px;
		}

		.adv {
			width: 100%;
		}

		.adv img {
			height: 300px;
		}
	</style>
</head>

<body>
	<header style="position: fixed;">
		<span style="text-align: center;">订购</span>
	</header>
	<div class="page__bd content">
		<div class="adv">
			<div class="swiper-container" onclick="pro()">
				<div class="swiper-wrapper"></div>
			</div>
		</div>
		<div class="box" data-nodeid="1" data-url="./buy/index.html">
			<div class="img" style="background:#e84c3d">
				上市
			</div>
			<span>顶上集成吊顶产品库 /VIP产品</span>
		</div>
		<div class="box borderBottom" data-nodeid="2" data-url="./qm/index.html">
			<div class="img" style="background:#8d44ad">
				高新
			</div><span>顶上集成背景·墙面</span>
		</div>
		<div class="box" data-nodeid="1" data-url="./factory/index.html">
			<div class="img" style="background:#27ae61">
				环保
			</div>
			<span>顶上工程定制</span>
		</div>
		<div class="box" data-nodeid="4" data-url="./ydqm/index.html">
			<div class="img" style="background:#f39c11">
				10大
			</div>
			<span>移动集成背景·墙面</span>
		</div>

		<div class="box" data-nodeid="3" data-url="./ydceil/index.html">
			<div class="img" style="background:#3598db">
				定制
			</div>
			<span>移动集成吊顶</span>
		</div>
	</div>

</body>
<script id="interpolationtmpl" type="text/x-dot-template">
	{{~it:value:index}}
	<div class="swiper-slide"><img src="../image/default.jpg" class="pic" data-original="http://www.d-shang.com/{{=value.image}}"></div>
	{{~}}
</script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/weui.min.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/wolf.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/zepto.picLazyLoad.min.js"></script>
<script src="../script/swiper-3.3.1.min.js"></script>
<script type="text/javascript">
	var OPENID;
	var NODE;
	var URL;
	apiready = function() {
		OPENID = api.getPrefs({
			sync: true,
			key: 'openid'
		});

		setTopBar();
		$(".box").bind("click", shows);

		loadAdv();
	};

	function lunbo() {
		var mySwiper = new Swiper('.swiper-container', {
			autoplay: 2000,
			loop: true,
			height: 300
		})

	}





	function shows() {
		NODE = $(this).attr("data-nodeid");
		URL = $(this).attr("data-url");
		//免密码
		var ret = getLocalPassword();


		if (ret.status == true) {
			checkQX(ret.password, 0);
			return false;
		}



		var isFinger = api.getPrefs({
			sync: true,
			key: 'fingerPrint'
		});

		var OS = api.systemType;
		if (OS == "ios" && isFinger == 1) {
			var touchID = api.require('touchID');

			touchID.verify(
				function(ret, err) {
					if (ret.status) {
						fingerPrint();
					} else {
						if (ret.code == 0) {
							setPassword();
						} else if (ret.code == 1) {
							setPassword();

						} else if (ret.code == 2) {
							api.alert({
								msg: "验证三次失败,请用密码输入"
							});
							setPassword();

						} else if (ret.code == 3) {
							setPassword();

						} else {

							setPassword();
						}
					}
				});
		} else {
			setPassword();
		}
	}



	function setPassword() {


		api.prompt({
			title: '授权密码',
			msg: '授权后1小时内免密码输入哦',
			buttons: ['取消', '确定']
		}, function(ret, err) {
			var index = ret.buttonIndex;
			var text = ret.text;
			if (index == 2) {
				sq(ret.text);
			}
		});

	}

	function pro() {
		api.openWin({
			name: 'product',
			url: './goods/index.html'
		});
	}

	function help() {
		api.openWin({
			name: 'letter',
			url: './active/letter.html',
			slidBackEnabled: false
		});
	}

	function loadAdv() {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appanonymous/getadvbytype/?type=7&openid=' + OPENID
		}, function(ret, err) {
			//coding...
			var d = ret.data;
			var arrText = doT.template($("#interpolationtmpl").text());
			$(".swiper-wrapper").html(arrText(ret.data));
			lunbo();
			$('.pic').picLazyLoad();
		});
	}

	function sq(password) {


		if (password == null || password == undefined) {
			api.toast({
				msg: '授权密码不能为空',
				duration: 1000,
				location: 'middle'
			});
			return false;
		}
		checkQX(password, 1);
	}


	function fingerPrint() {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/fingerprint/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}


	function checkQX(password, isAutoPwd) {
		api.ajax({
			url: 'http://www.d-shang.com/index.php?appbuy/authorize/?openid=' + OPENID,
			method: "post",
			data: {
				values: {
					"password": password,
					"node": NODE
				}
			}
		}, function(ret, err) {
			if (ret.status) {
				//授权成功记住密码
				recordPassword(password, isAutoPwd);


				jump();
			} else {
				api.toast({
					msg: ret.message,
					duration: 2000,
					location: 'middle'
				});
				return false;
			}
		});
	}

	function jump() {

		var num = Math.round(Math.random() * 10);
		if (NODE == 1) {
			api.openWin({
				name: 'buy' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
		if (NODE == 2) {
			api.openWin({
				name: 'qm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}

		if (NODE == 3) {
			api.openWin({
				name: 'ydceil' + num,
				url: URL,
				slidBackEnabled: false
			});
		}


		if (NODE == 4) {
			api.openWin({
				name: 'ydqm' + num,
				url: URL,
				slidBackEnabled: false
			});
		}
	}

	function recordPassword(password, isAutoPwd) {

		if (isAutoPwd == 0) {
			return false;
		}

		var add_time = new Date().getTime();
		var obj = {
			"password": password,
			"add_time": add_time
		};

		var objString = JSON.stringify(obj);
		api.setPrefs({
			key: 'password',
			value: obj
		});
	}

	function getLocalPassword() {
		var string = api.getPrefs({
			key: 'password',
			sync: true
		});
    if(string==""){
			return {"status":false,"password":""};
		}

		var obj = $.parseJSON(string);
		var currentTime = new Date().getTime();
		var ret;
		if ((currentTime - obj.add_time) > 3600000) {
			ret = {
				"status": false,
				'password': ""
			};
		} else {
			ret = {
				"status": true,
				"password": obj.password
			};
		}
		return ret;

	}
</script>

</html>
