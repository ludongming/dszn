<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>顶上宅配</title>
	<link rel="stylesheet" href="../../css/weui.min.css">
	<link rel="stylesheet" type="text/css" href="../../css/api.css" />
	<link rel="stylesheet" href="../../css/dropload.css">
	<link rel="stylesheet" href="../../css/header.css" />
	<link rel="stylesheet" href="../../css/dszp.css" />

</head>

<body>
	<header style="position: fixed;" class="page__bd page__bd_spacing">
		<i class="backBtn" ontouchend="goback()"><img src="../../image/back.png" class="back" /></i><span id="title" class="title" style="text-align: center;">顶上宅配</span>
	</header>
	<div class="page__bd content" id="contents">

		<div class="picarr"></div>



	</div>
	<script id="interpolationtmpl" type="text/x-dot-template">
		{{~it:value:index}}
		<div class="picbox  love{{=value.id}}">
			<a href="javascript:void(0)"><img src="../../image/defaultimage.png" data-original="http://www.dszpvip.com/{{=value.thumb}}" class="pic" onclick="jump({{=value.id}},{{=value.cid}},{{=value.index}})">


			</a>
			<div class="picname">
				<span class="love" id="love_{{=value.id}}" onclick="love({{=value.id}})" data-status="1"><img src="../../image/love1.png"   ></span> {{=value.title}}

			</div>
			<div style="margin-top: 5px;padding-left: 2px;">
			</div>
		</div>
		{{~}}
	</script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script src="../../script/zepto.min.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/weui.min.js"></script>
<script src="../../script/wolf.js"></script>
<script type="text/javascript" src="../../script/dropload.min.js"></script>
<script type="text/javascript" src="../../script/zepto.picLazyLoad.min.js"></script>
<script type="text/javascript">
	var OPENID;
	var isDrop = false;
	var PAGE = 1;
	var me;

	apiready = function() {
		setTopBar();
		isDrop = true;
		OPENID = api.getPrefs({
			sync: true,
			key: 'openid'
		});

		setDrop();


	}



	function love(id) {
		var status = $("#love_" + id).attr("data-status");
		var con = "";
		if (status == 0) {
			weui.toast("收藏成功", {
				duration: 1000,
				className: "bears"
			});
			con = "<img src=\"../../image/love1.png\">";
			status = 1;

			api.ajax({
				url: 'http://www.dszpvip.com/index.php?love/addlove/',
				method: "post",
				data: {
					values: {
						nid: id,
						openid: OPENID
					}
				}

			}, function(ret, err) {

				if (ret) {} else {
					alert(JSON.stringify(err));
				}
			});

		} else {
			$(".love"+id).remove();
			return;
			con = "<img src=\"../../image/love0.png\">";
			status = 0;
			api.ajax({
				url: 'http://www.dszpvip.com/index.php?love/removelovebyuidandnid/',
				method: "post",
				data: {
					values: {
						nid: id,
						openid: OPENID
					}
				}
			}, function(ret, err) {
				if (ret) {

				} else {
					alert(JSON.stringify(err));
				}
			});



		}
		$("#love_" + id).attr("data-status", status);

		$("#love_" + id).html(con);
	}

	function setDrop() {
		$('.content').dropload({
			scrollArea: window,
			autoLoad: true,
			domDown: {
				domClass: 'dropload-down',
				domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
				domLoad: '<div class="dropload-load"><span class="loading"></span>数据加载中</div>',
				domNoData: '<div class="dropload-noData">没有更多数据</div>'
			},
			loadDownFn: function(mes) {
				me = mes;
				phoneGetPic(me);
				PAGE++;
			},
			threshold: 50
		});

	}



	function goback() {
		api.closeWin();
	}



	//获取图片
	function phoneGetPic() {
		var url = 'http://www.dszpvip.com/index.php?love/getlovebyuid/';
		api.ajax({
			url: url,
			method: 'post',
			data: {
				values: {
					'openid': OPENID,
					'p': PAGE
				}
			}
		}, function(ret, err) {
			console.log(JSON.stringify(err));
			var d = ret.data;
			if (d.length == 0) {
				me.lock();
				me.noData();
			} else {
				var arrText = doT.template($("#interpolationtmpl").text());
				$(".picarr").append(arrText(d));
				$('.pic').picLazyLoad();
			}
			//第一次加载数量不足的情况
			if (d.length < 12) {
				me.lock();
				me.noData();
			}
			if (PAGE > 20) {
				me.lock();
				me.noData();
			}
			me.resetload();
		});
	}
</script>

</html>
