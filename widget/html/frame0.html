<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link rel="stylesheet" type="text/css" href="../css/api.css" />
	<link rel="stylesheet" type="text/css" href="../css/weui.min.css" />
	<link rel="stylesheet" type="text/css" href="../css/header.css" />
	<link rel="stylesheet" type="text/css" href="../css/swiper.min.css" />
	<link rel="stylesheet" href="../css/dropload.css">
	<style>
		body {
			background: #f5f5f5;
		}

		.content {
			min-height: 400px;
		}

		.tit a {
			color: #000;
			display: inline-block;
			text-align: center;
			font-size: 0.8em;
			width: 70px;
		}

		.tit .active span {
			border-bottom-width: 10px;
			display: inline-block;
			border-bottom: 1px #000 solid;
		}

		.list {
			background: #fff;
			width: 100%;
			border-bottom: 1px solid #f1f1f1;
			margin-bottom: 10px;
		}

		.list .info {
			height: 50px;
		}

		.list .info .head img {
			margin-top: 4px;
			float: left;
			width: 50px;
			height: 50px;
			border-radius: 50px;
			margin-left: 10px;
			vertical-align: middle;
		}

		.list .info .username {
			margin-left: 10px;
			margin-top: 15px;
			float: left;
			color: #000;
		}

		.list .info .pub_time {
			float: right;
			margin-top: 15px;
			margin-right: 10px;
			color: #666;
		}

		.list .image {
			margin-top: 10px;
			width: 100%;
			clear: both;
			max-height: 300px;
			overflow-y: hidden;
		}

		.list .message {
			width: 95%;
			padding-left: 10px;
		}

		.list .tip {
			margin-top: 5px;
			height: 25px;
			width: 100%;
			margin-bottom: 10px;
		}

		.list .tip .tool {
			float: right;
			width: 60px;
			margin-right: 10px;
		}

		.zan {
			font-size: 0.8em;
			color: #777;
			margin-right: 3px;
		}

		.dingwei {
			float: left;
			margin-left: 10px;
		}

		.reply {
			background: #f1f1f1;
			display: none;
		}

		.reply .text {
			width: 80%;
			float: left;
		}

		.input_text {
			margin-left: 10px;
			width: 90%;
			margin-top: 5px;
			height: 30px;
			border: none;
			background: #fff;
		}

		.replybtn {
			text-align: center;
			border-radius: 4px;
			display: inline-block;
			width: 60px;
			height: 30px;
			line-height: 30px;
			margin-top: 5px;
			border: 1px #ccc solid;
			background: #fff;
			color: #666;
		}

		.comment {
			color: #746e7c;
			width: 100%;
			clear: both;
			font-size: 0.9em;
			max-height: 200px;
			overflow-y: hidden;
		}

		.commentlist {
			width: 90%;
			margin: 0 auto;
			border-radius: 4px;
			background: #f5f5f5;
			padding: 4px;
			font-size: 0.9em;
			color: #989898;
			margin-bottom: 10px;
		}

		.pub_time {
			font-size: 0.8em;
			color: #ccc;
		}

		.qd_left {
			width: 49%;
			float: left;
		}

		.qd_right {
			text-align: center;
			width: 49%;
			height: 80px;
			margin-top: 10px;
			background: #fff;
			color: #000;
			float: left;
		}

		.qd {
			width: 100%;
			height: 150px;
			line-height: 50px;
			color: #fff;
			font-size: 1.2em;
			background-image: url(../image/mrqd1.png);
			position: relative;
			text-align: center;
		}

		.jingxuan {
			width: 100%;
			height: 150px;
			line-height: 50px;
			color: #fff;
			font-size: 1.2em;
			background-image: url(../image/jingxuan.png);
			position: relative;
			text-align: center;
		}

		.toolimage {
			width: 25px;
			height: 25px;
			vertical-align: middle;
		}

		.rq {
			display: inline-block;
			width: 40px;
			height: 40px;
			font-size: 1.3em;
			font-weight: 700;
			background: #fff;
			color: #000;
		}
	</style>
</head>

<body>
	<header style="position: fixed;">
		<img src="../image/xj.png" ontouchend="friend()" style="width:25px;margin-top:8px; margin-left:10px; vertical-align:middle;float:left;">
		<span class="tit"> <a href="javascript:;"  ontouchend="hot()" class="tab active" id="hot"> <span>精选</span></a> <a href="javascript:;" ontouchend="zuixin()" id="zuixin" class="tab"><span>最新</span></a> </span>
		<span style="display:inline-block;position:relative;float:right;margin-right:10px; "> <img src="../image/laba.png" ontouchend="notice()"  style="width:25px; margin-top:8px; vertical-align:middle;"> <span class="weui-badge" style="display:none;position: absolute;bottom: -2px;right:-6px;">0</span>		</span>
	</header>
	<div class="page__bd content">
		<div class="swiper-container">
			<div class="swiper-wrapper">
				<div class="swiper-slide swiper-no-swiping">
					<div class="recommendmain">
						<div class="qd" onclick="clock()">
							<div style="width:80px;height:90px;line-height:40px;text-align:center;right:10%;top:20%;position:absolute;background:#000;opacity: 0.7;">
								<span style="font-size:0.9em;">每日签到</span>
								<br>
								<span class="rq"></span>
							</div>
						</div>
						<div id="recommendmain"></div>
					</div>
				</div>
				<div class="swiper-slide swiper-no-swiping">
					<div class="allmain">
						<div class="jingxuan" onclick="clock()"></div>
						<div id="allmain"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<!--地址模板-->
<script id="interpolationtmpl" type="text/x-dot-template">
	{{~it:value:index}}
	<div class="list">
		<div class="info">
			<div class="head" onclick="user({{=value.uid}})">
				<img src="../image/default.png" data-original="{{=value.headimgurl}}" class="pic" style="vertical-align:middle;">
			</div>
			<div class="username">{{=value.real_name}}</div>
			<div class="pub_time">{{=value.rq}}</div>
		</div>
		<div class="image">
			<img src="../image/timg.jpg" data-original="http://www.d-shang.com{{=value.image}}" class="pic" width="100%;" onclick="bigImage('http://www.d-shang.com{{=value.image}}')">
		</div>
		<div class="message">{{=value.content}}</div>
		<div class="tip">
			<div class="dingwei">
				<img src="../image/dingwei.png" style="width:25px;vertical-align:middle;"> <span class="zan">{{=value.address}}</a>
		</div>
		<div class="tool">
		<span class="zan zan_{{=value.id}}">{{?value.flower>0}} {{=value.flower}} {{?}}</span>

				<img src="../image/zan{{=value.isflower}}.png" id="zanimage{{=value.id}}" data="{{=value.isflower}}" class="toolimage" ontouchend="zan({{=value.id}})">
			</div>
		</div>
		<div class="reply pl{{=value.id}}">
			<div class="text">
				<input type="text" id="text{{=value.id}}" class="input_text" value="">
			</div>
			<div class="reply_btn">
				<a href="javascript:;" class="replybtn" ontouchend="addComment()">发送</a>
			</div>
		</div>
		{{?value.flower>0}}
		<div class="comment">
			<div class="commentlist">
				<span class="commentfirst"></span> {{ for(var i=0, catlen=value.flowers.length; i
				<catlen; i++) { }} <span> {{=value.flowers[i].real_name}} {{?i==value.flower-1}}{{??}},{{?}}
					</span>
					{{ } }} 点赞了哦
			</div>
		</div>
		{{?}}
	</div>
	{{~}}
</script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/weui.min.js"></script>
<script type="text/javascript" src="../script/wolf.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/fx.js"></script>
<script type="text/javascript" src="../script/swiper-3.3.1.min.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/dropload.min.js"></script>
<script type="text/javascript" src="../script/zepto.picLazyLoad.min.js"></script>
<script type="text/javascript">
	var OPENID;
	var page1 = 1;
	var page2 = 1;
	var me1;
	var me2;
	var REPLYID = 0;
	var mySwiper;
	apiready = function() {
		setTopBar();
		OPENID = api.getPrefs({
			sync: true,
			key: 'openid'
		});
		rq();
		setRecommendDrop();
		setAllDrop();
		mySwiper = new Swiper('.swiper-container', {
			noSwiping: true
		})
	};

	function rq() {
		var myDate = new Date();
		var month = myDate.getMonth() + 1;
		var day = myDate.getDate();
		$(".rq").html(day);
	}

	function zuixin() {
		$("body").scrollTop(0);
		$("#zuixin").addClass("active");
		$("#hot").removeClass("active");
		mySwiper.slideNext();
	}

	function hot() {
		$("#zuixin").removeClass("active");
		$("#hot").addClass("active");
		mySwiper.slidePrev();
	}

	function pinglun(id) {
		if (REPLYID > 0) {
			$(".pl" + REPLYID).hide();
		}
		REPLYID = id;
		$(".pl" + id).show();
		$("#text" + id).focus();
	}

	function cleanBadge() {
		$(".weui-badge").html(0);
		$(".weui-badge").hide();
	}

	function clock() {
		api.openWin({
			name: 'clock',
			url: './clock.html'
		});
	}

	function setBadgeNum(num) {
		var num = $(".weui-badge").html();
		num = parseInt(num) + 1;
		$(".weui-badge").html(num);
		$(".weui-badge").show();
	}

	function user(uid) {
		api.openWin({
			name: 'user',
			url: './friends/user.html',
			pageParam: {
				uid: uid
			}
		});
	}

	function bigImage(image) {
		var photoBrowser = api.require('photoBrowser');
		photoBrowser.open({
			images: [image],
			placeholderImg: 'widget://res/img/apicloud.png',
			bgColor: '#000'
		}, function(ret, err) {
			if (ret.eventType == "click") {
				photoBrowser.close();
			}

			if (ret.eventType == "longPress") {
				var img=photoBrowser.getI
				saveImage(image);
			}

		});
	}

	function saveImage(image) {
		api.confirm({
			title: '提示',
			msg: '保存图片到手机',
			buttons: ['确定', '取消']
		}, function(ret, err) {
			var index = ret.buttonIndex;
			if (index == 1) {
				api.saveMediaToAlbum({
					path: image
				}, function(ret, err) {
					if (ret && ret.status) {
						api.toast({
							msg: '保存成功',
							duration: 1000,
							location: 'bottom'
						});
					} else {
						alert('保存失败');
					}
				});
			}
		});

	}


	function notice() {
		api.openWin({
			name: 'notice',
			url: './notice.html'
		});
	}

	function zan(nid) {
		var isZan = $("#zanimage" + nid).attr("data");
		var flower = $(".zan_" + nid).html();
		if (flower == "") {
			flower = 0;
		}
		if (isZan == 1) {
			flower = parseInt(flower) - 1;
			$("#zanimage" + nid).attr("data", 0);
			$("#zanimage" + nid).attr("src", "../image/zan0.png");
		} else {
			flower = parseInt(flower) + 1;
			$("#zanimage" + nid).attr("data", 1);
			$("#zanimage" + nid).attr("src", "../image/zan1.png");
			$("#zanimage" + nid).css({
				height: "30px",
				width: "30px"
			});
			$("#zanimage" + nid).animate({
				height: "25px",
				width: "25px"
			}, 500);
		}
		$(".zan_" + nid).html(flower);
		api.ajax({
			url: 'http://www.d-shang.com/index.php?blog/flower/?openid=' + OPENID + "&nid=" + nid
		}, function(ret, err) {});
	}

	function friend() {
		api.openWin({
			name: 'friend',
			url: './friends/add.html'
		});
	}

	function setRecommendDrop() {
		$('.recommendmain').dropload({
			scrollArea: window,
			autoLoad: true,
			domDown: {
				domClass: 'dropload-down',
				domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
				domLoad: '<div class="dropload-load"><span class="loading"></span>数据加载中</div>',
				domNoData: '<div class="dropload-noData">没有更多数据</div>'
			},
			domUp: {
				domClass: 'dropload-down',
				domRefresh: '<div class="dropload-refresh">↑下拉更新</div>',
				domLoad: '<div class="dropload-load"><span class="loading"></span>数据加载中</div>',
				domNoData: '<div class="dropload-noData">已刷新</div>'
			},
			loadDownFn: function(mes) {
				me1 = mes;
				loadRecommendData();
				page1 += 1;
			},
			loadUpFn: function(mes) {
				me1 = mes;
				page1 = 1;
				rq();
				$("#recommendmain").html("");
				loadRecommendData();
				page1 += 1;
			},
			threshold: 50
		});
	}

	function setAllDrop() {
		$('.allmain').dropload({
			scrollArea: window,
			autoLoad: true,
			domDown: {
				domClass: 'dropload-down',
				domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
				domLoad: '<div class="dropload-load"><span class="loading"></span>数据加载中</div>',
				domNoData: '<div class="dropload-noData">没有更多数据</div>'
			},
			domUp: {
				domClass: 'dropload-down',
				domRefresh: '<div class="dropload-refresh">↑下拉更新</div>',
				domLoad: '<div class="dropload-load"><span class="loading"></span>数据加载中</div>',
				domNoData: '<div class="dropload-noData">已刷新</div>'
			},
			loadDownFn: function(mes) {
				me2 = mes;
				loadAllData();
				page2 += 1;
			},
			loadUpFn: function(mes) {
				me2 = mes;
				page2 = 1;
				$("#allmain").html("");
				loadAllData();
				page2 += 1;
			},
			threshold: 50
		});
	}

	function refresh() {
		location.reload();
	}

	function loadRecommendData() {

		api.ajax({
			url: 'http://www.d-shang.com/index.php?blog/getrecommendblogbypage/?p=' + page1 + "&openid=" + OPENID,
			timeout: 5,
			report: false
		}, function(ret, err) {
			me1.resetload();

			if (ret.status) {
				var d = ret.data;
				var arrText = doT.template($("#interpolationtmpl").text());
				$("#recommendmain").append(arrText(d));
				$('.pic').picLazyLoad();
				//第一次加载数量不足的情况
				if (page1 > 3) {
					me1.lock();
					me1.noData(false);
				}
			}
		});
	}

	function loadAllData() {

		api.ajax({
			url: 'http://www.d-shang.com/index.php?blog/getblogbypage/?p=' + page2 + "&openid=" + OPENID,
			timeout: 5,
			report: false
		}, function(ret, err) {
			me2.resetload();

			if (ret.status) {
				var d = ret.data;
				var arrText = doT.template($("#interpolationtmpl").text());
				$("#allmain").append(arrText(d));
				$('.pic').picLazyLoad();
				//第一次加载数量不足的情况
				if (page2 > 3) {
					me2.lock();
					me2.noData(false);
				}
			}
		});
	}
</script>

</html>
